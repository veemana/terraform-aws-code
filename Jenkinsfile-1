pipeline {
  agent {
    docker {
      image 'hashicorp/terraform:latest'
      args '-v $HOME/.aws:/root/.aws'
    }
  }

  environment {
        AWS_ACCESS_KEY_ID = credentials('access_key')
        AWS_SECRET_ACCESS_KEY = credentials('secret_key')
        TF_VAR_region = 'eu-north-1'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM', branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/veemana/terraform-aws-code.git']]])
      }
    }

    stage('Terraform Init') {
      steps {
        sh 'terraform init -backend-config "bucket=my-terraform-state-bucket" -backend-config "key=my-terraform-state-key" -backend-config "region=eu-north-1"'
      }
    }

    stage('Terraform Plan') {
      steps {
        sh 'terraform plan -var-file=my-vars.tfvars -var region=eu-north-1 -var ami=ami-0c55b159cbfafe1f0 -var instance_type=t2.micro'
      }
    }

    stage('Terraform Apply') {
      steps {
        sh 'terraform apply'
      }
    }
  }
}
